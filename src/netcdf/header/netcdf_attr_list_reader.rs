use std::io::{BufReader, Read, Seek};

use byteorder::{BigEndian, ReadBytesExt};

use crate::netcdf::common::netcdf_error::NetCdfError;
use crate::netcdf::header::netcdf_attr::NetCdfAttr;
use crate::netcdf::header::netcdf_attr_list::NetCdfAttrList;
use crate::netcdf::header::netcdf_attr_reader::NetCdfAttrReader;

pub struct NetCdfAttrListReader;


impl NetCdfAttrListReader {
    const NC_ATTRIBUTE_TAG: u32 = 0x000C;

    pub fn read<T: Read + Seek>(reader: &mut BufReader<T>) -> Result<NetCdfAttrList, NetCdfError> {
        let nc_attribute_tag = reader.read_u32::<BigEndian>()?;
        if nc_attribute_tag != Self::NC_ATTRIBUTE_TAG {
            let empty_attr_list = NetCdfAttrList::new(vec![]);
            return Ok(empty_attr_list);
        }

        let mut attributes: Vec<NetCdfAttr> = vec![];
        let num_elements = reader.read_u32::<BigEndian>()?;
        for _ in 0..num_elements {
            let attr = NetCdfAttrReader::read(reader)?;
            attributes.push(attr);
        }

        let attr_list = NetCdfAttrList::new(attributes);

        return Ok(attr_list);
    }
}


#[cfg(test)]
mod tests {
    use std::io::{BufReader, Cursor, Seek};

    use crate::netcdf::common::netcdf_value_type::NetCdfValueType;
    use crate::netcdf::common::netcdf_values::NetCdfValues;
    use crate::netcdf::header::netcdf_attr_list_reader::NetCdfAttrListReader;

    fn get_chars(values: &NetCdfValues) -> String {
        return match values {
            NetCdfValues::CharValues(chars) => chars.into_iter().collect(),
            _ => panic!("invalid value type")
        }
    }


    fn get_ints(values: &NetCdfValues) -> Vec<i32> {
        return match values {
            NetCdfValues::IntValues(ints) => ints.to_vec(),
            _ => panic!("invalid value type")
        }
    }


    fn get_doubles(values: &NetCdfValues) -> Vec<f64> {
        return match values {
            NetCdfValues::DoubleValues(doubles) => doubles.to_vec(),
            _ => panic!("invalid value type")
        }
    }


    #[test]
    fn it_correctly_parses_the_num_recs() {
        let mut reader = BufReader::new(Cursor::new([
            0x00, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x05, 0x74, 0x69, 0x74, 0x6C, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x15, 0x49, 0x43, 0x4F, 0x4E,
            0x20, 0x67, 0x72, 0x69, 0x64, 0x20, 0x64, 0x65, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x68, 0x69, 0x73, 0x74, 0x6F, 0x72, 0x79, 0x00,
            0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x4E, 0x2F, 0x70, 0x61, 0x6E, 0x66, 0x73, 0x2F, 0x65, 0x2F, 0x76, 0x6F, 0x6C, 0x32, 0x2F, 0x67, 0x7A, 0x61, 0x65, 0x6E, 0x67, 0x6C, 0x2F, 0x69, 0x63,
            0x6F, 0x6E, 0x2D, 0x64, 0x65, 0x76, 0x2F, 0x62, 0x75, 0x69, 0x6C, 0x64, 0x2F, 0x78, 0x38, 0x36, 0x5F, 0x36, 0x34, 0x2D, 0x75, 0x6E, 0x6B, 0x6E, 0x6F, 0x77, 0x6E, 0x2D, 0x6C, 0x69, 0x6E, 0x75,
            0x78, 0x2D, 0x67, 0x6E, 0x75, 0x2F, 0x62, 0x69, 0x6E, 0x2F, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x63, 0x6F, 0x6D, 0x6D, 0x61, 0x6E, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x69, 0x6E, 0x73, 0x74,
            0x69, 0x74, 0x75, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x3B, 0x4D, 0x61, 0x78, 0x20, 0x50, 0x6C, 0x61, 0x6E, 0x63, 0x6B, 0x20, 0x49, 0x6E, 0x73, 0x74, 0x69,
            0x74, 0x75, 0x74, 0x65, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x4D, 0x65, 0x74, 0x65, 0x6F, 0x72, 0x6F, 0x6C, 0x6F, 0x67, 0x79, 0x2F, 0x44, 0x65, 0x75, 0x74, 0x73, 0x63, 0x68, 0x65, 0x72, 0x20, 0x57,
            0x65, 0x74, 0x74, 0x65, 0x72, 0x64, 0x69, 0x65, 0x6E, 0x73, 0x74, 0x00, 0x00, 0x00, 0x00, 0x06, 0x73, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0A,
            0x69, 0x63, 0x6F, 0x6E, 0x2D, 0x64, 0x65, 0x76, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x75, 0x75, 0x69, 0x64, 0x4F, 0x66, 0x48, 0x47, 0x72, 0x69, 0x64, 0x00, 0x00, 0x00, 0x00, 0x02,
            0x00, 0x00, 0x00, 0x24, 0x61, 0x32, 0x37, 0x62, 0x38, 0x64, 0x65, 0x36, 0x2D, 0x31, 0x38, 0x63, 0x34, 0x2D, 0x31, 0x31, 0x65, 0x34, 0x2D, 0x38, 0x32, 0x30, 0x61, 0x2D, 0x62, 0x35, 0x62, 0x30,
            0x39, 0x38, 0x63, 0x36, 0x61, 0x35, 0x63, 0x30, 0x00, 0x00, 0x00, 0x13, 0x6E, 0x75, 0x6D, 0x62, 0x65, 0x72, 0x5F, 0x6F, 0x66, 0x5F, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x75, 0x73, 0x65, 0x64, 0x00,
            0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1A, 0x00, 0x00, 0x00, 0x12, 0x49, 0x43, 0x4F, 0x4E, 0x5F, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x66, 0x69, 0x6C, 0x65, 0x5F, 0x75,
            0x72, 0x69, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x4B, 0x68, 0x74, 0x74, 0x70, 0x3A, 0x2F, 0x2F, 0x69, 0x63, 0x6F, 0x6E, 0x2D, 0x64, 0x6F, 0x77, 0x6E, 0x6C, 0x6F, 0x61, 0x64,
            0x73, 0x2E, 0x6D, 0x70, 0x69, 0x6D, 0x65, 0x74, 0x2E, 0x6D, 0x70, 0x67, 0x2E, 0x64, 0x65, 0x2F, 0x67, 0x72, 0x69, 0x64, 0x73, 0x2F, 0x70, 0x75, 0x62, 0x6C, 0x69, 0x63, 0x2F, 0x69, 0x63, 0x6F,
            0x6E, 0x5F, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x30, 0x30, 0x32, 0x36, 0x5F, 0x52, 0x30, 0x33, 0x42, 0x30, 0x37, 0x5F, 0x47, 0x2E, 0x6E, 0x63, 0x00, 0x00, 0x00, 0x00, 0x06, 0x63, 0x65, 0x6E, 0x74,
            0x72, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x4E, 0x00, 0x00, 0x00, 0x09, 0x73, 0x75, 0x62, 0x63, 0x65, 0x6E, 0x74, 0x72, 0x65, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x0D, 0x6F, 0x75, 0x74, 0x6E, 0x61, 0x6D, 0x65, 0x5F, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x11, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x6D, 0x61, 0x70, 0x70, 0x69, 0x6E, 0x67, 0x5F, 0x6E, 0x61, 0x6D,
            0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x12, 0x6C, 0x61, 0x74, 0x5F, 0x6C, 0x6F, 0x6E, 0x67, 0x5F, 0x6F, 0x6E, 0x5F, 0x73, 0x70, 0x68, 0x65, 0x72, 0x65, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x06, 0x63, 0x72, 0x73, 0x5F, 0x69, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x1C, 0x75, 0x72, 0x6E, 0x3A, 0x6F, 0x67, 0x63, 0x3A, 0x64, 0x65, 0x66, 0x3A,
            0x63, 0x73, 0x3A, 0x45, 0x50, 0x53, 0x47, 0x3A, 0x36, 0x2E, 0x30, 0x3A, 0x36, 0x34, 0x32, 0x32, 0x00, 0x00, 0x00, 0x08, 0x63, 0x72, 0x73, 0x5F, 0x6E, 0x61, 0x6D, 0x65, 0x00, 0x00, 0x00, 0x02,
            0x00, 0x00, 0x00, 0x1E, 0x53, 0x70, 0x68, 0x65, 0x72, 0x69, 0x63, 0x61, 0x6C, 0x20, 0x32, 0x44, 0x20, 0x43, 0x6F, 0x6F, 0x72, 0x64, 0x69, 0x6E, 0x61, 0x74, 0x65, 0x20, 0x53, 0x79, 0x73, 0x74,
            0x65, 0x6D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x65, 0x6C, 0x6C, 0x69, 0x70, 0x73, 0x6F, 0x69, 0x64, 0x5F, 0x6E, 0x61, 0x6D, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x06,
            0x53, 0x70, 0x68, 0x65, 0x72, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x73, 0x65, 0x6D, 0x69, 0x5F, 0x6D, 0x61, 0x6A, 0x6F, 0x72, 0x5F, 0x61, 0x78, 0x69, 0x73, 0x00, 0x00, 0x00, 0x00, 0x06,
            0x00, 0x00, 0x00, 0x01, 0x41, 0x58, 0x4D, 0xE7, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x69, 0x6E, 0x76, 0x65, 0x72, 0x73, 0x65, 0x5F, 0x66, 0x6C, 0x61, 0x74, 0x74, 0x65, 0x6E, 0x69,
            0x6E, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x6C, 0x65, 0x76,
            0x65, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x09, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x72, 0x6F, 0x6F, 0x74, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x07, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x49, 0x44, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
            0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0E, 0x70, 0x61, 0x72, 0x65, 0x6E, 0x74, 0x5F, 0x67, 0x72, 0x69, 0x64, 0x5F, 0x49, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x6D, 0x61, 0x78, 0x5F, 0x63, 0x68, 0x69, 0x6C, 0x64, 0x64, 0x6F, 0x6D, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01
        ]));

        let result = NetCdfAttrListReader::read(&mut reader);
        assert!(result.is_ok());

        let attr_list = result.unwrap();
        assert_eq!(21, attr_list.attributes.len());

        assert_eq!("title", attr_list.attributes[0].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[0].nc_type);
        assert_eq!("ICON grid description", get_chars(&attr_list.attributes[0].values));

        assert_eq!("history", attr_list.attributes[1].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[1].nc_type);
        assert_eq!("/panfs/e/vol2/gzaengl/icon-dev/build/x86_64-unknown-linux-gnu/bin/grid_command", get_chars(&attr_list.attributes[1].values));

        assert_eq!("institution", attr_list.attributes[2].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[2].nc_type);
        assert_eq!("Max Planck Institute for Meteorology/Deutscher Wetterdienst", get_chars(&attr_list.attributes[2].values));

        assert_eq!("source", attr_list.attributes[3].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[3].nc_type);
        // assert_eq!("icon-dev", get_chars(&attr_list.attributes[3].values));

        assert_eq!("uuidOfHGrid", attr_list.attributes[4].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[4].nc_type);
        assert_eq!("a27b8de6-18c4-11e4-820a-b5b098c6a5c0", get_chars(&attr_list.attributes[4].values));

        assert_eq!("number_of_grid_used", attr_list.attributes[5].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[5].nc_type);
        assert_eq!(vec![26], get_ints(&attr_list.attributes[5].values));

        assert_eq!("ICON_grid_file_uri", attr_list.attributes[6].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[6].nc_type);
        assert_eq!("http://icon-downloads.mpimet.mpg.de/grids/public/icon_grid_0026_R03B07_G.nc", get_chars(&attr_list.attributes[6].values));

        assert_eq!("centre", attr_list.attributes[7].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[7].nc_type);
        assert_eq!(vec![78], get_ints(&attr_list.attributes[7].values));

        assert_eq!("subcentre", attr_list.attributes[8].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[8].nc_type);
        assert_eq!(vec![255], get_ints(&attr_list.attributes[8].values));

        assert_eq!("outname_style", attr_list.attributes[9].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[9].nc_type);
        assert_eq!(vec![2], get_ints(&attr_list.attributes[9].values));

        assert_eq!("grid_mapping_name", attr_list.attributes[10].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[10].nc_type);
        assert_eq!("lat_long_on_sphere", get_chars(&attr_list.attributes[10].values));

        assert_eq!("crs_id", attr_list.attributes[11].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[11].nc_type);
        assert_eq!("urn:ogc:def:cs:EPSG:6.0:6422", get_chars(&attr_list.attributes[11].values));

        assert_eq!("crs_name", attr_list.attributes[12].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[12].nc_type);
        assert_eq!("Spherical 2D Coordinate System", get_chars(&attr_list.attributes[12].values));

        assert_eq!("ellipsoid_name", attr_list.attributes[13].name);
        assert_eq!(NetCdfValueType::NcChar, attr_list.attributes[13].nc_type);
        assert_eq!("Sphere", get_chars(&attr_list.attributes[13].values));

        assert_eq!("semi_major_axis", attr_list.attributes[14].name);
        assert_eq!(NetCdfValueType::NcDouble, attr_list.attributes[14].nc_type);
        assert_eq!(vec![6371229.0], get_doubles(&attr_list.attributes[14].values));

        assert_eq!("inverse_flattening", attr_list.attributes[15].name);
        assert_eq!(NetCdfValueType::NcDouble, attr_list.attributes[15].nc_type);
        assert_eq!(vec![0.0], get_doubles(&attr_list.attributes[15].values));

        assert_eq!("grid_level", attr_list.attributes[16].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[16].nc_type);
        assert_eq!(vec![7], get_ints(&attr_list.attributes[16].values));

        assert_eq!("grid_root", attr_list.attributes[17].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[17].nc_type);
        assert_eq!(vec![3], get_ints(&attr_list.attributes[17].values));

        assert_eq!("grid_ID", attr_list.attributes[18].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[18].nc_type);
        assert_eq!(vec![1], get_ints(&attr_list.attributes[18].values));

        assert_eq!("parent_grid_ID", attr_list.attributes[19].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[19].nc_type);
        assert_eq!(vec![0], get_ints(&attr_list.attributes[19].values));

        assert_eq!("max_childdom", attr_list.attributes[20].name);
        assert_eq!(NetCdfValueType::NcInt, attr_list.attributes[20].nc_type);
        assert_eq!(vec![1], get_ints(&attr_list.attributes[20].values));

        assert_eq!(960 as u64, reader.stream_position().unwrap())
    }


    #[test]
    fn it_correctly_parses_an_absent_attr_list() {
        let mut reader = BufReader::new(Cursor::new([
            0x00, 0x00, 0x00, 0x00
        ]));

        let result = NetCdfAttrListReader::read(&mut reader);
        assert!(result.is_ok());

        let attr_list = result.unwrap();
        assert_eq!(0, attr_list.attributes.len());

        assert_eq!(4 as u64, reader.stream_position().unwrap())
    }
}
